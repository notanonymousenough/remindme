<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  
  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="icon" href="../assets/icons/icon.png" type="image/x-icon">

  <title>RemindMe</title>

</head> 
<body>

  <nav class="mnb navbar navbar-default navbar-fixed-top btn-menu " >
    <div class="container-fluid">
      <div class="navbar-header ">
        <button type="button" id="msbo"   class="navbar-toggler collapsed btn-box"  data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" >
          <span class="navbar-toggler-icon "></span>
        </button> 
      </div>
    </div>
  </nav>
 
  <div class="msb   " id="msb" >
    <nav class="navbar navbar-default  " role="navigation">
      <div class="brand-name-wrapper">
        <div class="avatar">
          <img  src="../assets/icons/avatar.jpg" alt="" class="round" width="40" height="40">
          <a class="navbar-brand" href="/user" >
            <b> Профиль</b>
          </a>
        </div>
      </div>
      <div class="side-menu-container  ">
        <ul class="nav navbar-nav ">
          <li>
            <a class="nav-link text-dark item" href="/reminders">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"  fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16"><path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/></svg>
              Напоминания
            </a>
          </li>
          <li>
            <a class="nav-link text-dark item" href="/habits">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg> 
              Привычки
            </a>
          </li>
          <li>
            <a class="nav-link text-dark item" href="/telegram">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-telegram" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426 0 0 0-.013-.315.337.337 0 0 0-.114-.217.526.526 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09z"/></svg>
              Телеграм-бот
            </a>
          </li>
          <li>
            <a class="nav-link text-dark item" href="#item-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-question-lg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.475 5.458c-.284 0-.514-.237-.47-.517C4.28 3.24 5.576 2 7.825 2c2.25 0 3.767 1.36 3.767 3.215 0 1.344-.665 2.288-1.79 2.973-1.1.659-1.414 1.118-1.414 2.01v.03a.5.5 0 0 1-.5.5h-.77a.5.5 0 0 1-.5-.495l-.003-.2c-.043-1.221.477-2.001 1.645-2.712 1.03-.632 1.397-1.135 1.397-2.028 0-.979-.758-1.698-1.926-1.698-1.009 0-1.71.529-1.938 1.402-.066.254-.278.461-.54.461h-.777ZM7.496 14c.622 0 1.095-.474 1.095-1.09 0-.618-.473-1.092-1.095-1.092-.606 0-1.087.474-1.087 1.091S6.89 14 7.496 14Z"/></svg>
              Помощь
            </a>
          </li>	
        </ul>
      </div>
    </nav>  
  </div>
 
  <div class="mcw">
    <div class="row">
      <div class="col-4 col-sm-3 col-md-2"></div>
      <div class="navbar navbar-light d-inline-flex col-8 col-sm-3 col-lg-3">
        <div class="container-fluid">
          <form class="d-flex" id="reminderForm">
            <input class="form-control me-2 navbar-find" type="search" id="reminderInput" placeholder="Добавить напоминание" aria-label="Поиск"
                   data-bs-toggle="dropdown" aria-expanded="false" autocomplete="off">
            <div class="dropdown-menu p-3" style="width: 280px;">
              <ul id="tagsList" class="list-unstyled mb-3" style="max-height: 150px; overflow-y: auto;"></ul>
              <input type="datetime-local" id="timeInput" class="form-control mb-2" style="width: 100%;">
              <button type="button" id="saveButton" class="btn btn-primary w-100">Сохранить</button>
            </div>
          </form>
        </div>
      </div>
      <div class="col-10 col-sm-10 col-lg-4 m-1 ">
        <div  class="fire">
          <img src="../assets/icons/fire.png" width="50" height="70" />
        </div>
        <div class="progress">
          <div class="progress-bar progress-bar-striped bg-warning" role="progressbar" id="progress-bar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
      </div>
      <div class="col-1 col-md-2"></div>
    </div>
    <div class="row">
      <div class="col-1 col-sm-2 col-md-2"></div>
      <div class="btn-filitr col-3 col-sm-4 col-md-3 col-lg-2 m-1">
        <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
          Фильтр
        </button>
        <ul id="tagsList" class="list-unstyled mb-3" style="max-height: 150px; overflow-y: auto;"></ul>
      </div>
      <div class="col-1 col-sm-1"></div>
      <div class="btn-teg col-3 col-sm-2 col-md-2 col-lg-1 m-1">
        <form action="">
          <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
            Тэг
          </button>
          <ul id="tags" class="list-unstyled dropdown-menu" style="max-height: 150px; overflow-y: auto;">
            <li class="form-check m-1">
              <input class="form-check-input " type="radio" name="flexRadioDefault" id="flexRadioDefault2" value="Все" checked>
              <label class="form-check-label" for="flexRadioDefault2">
                Все
              </label>
            </li>
          </ul>
        </form>
      </div>
      <div class="btn-add col-2 col-sm-2 col-md-3 m-1"> 
        <button class="btn btn-primary" id="btn-add"  onclick="add_teg()" type="button">&#10010</button>
        <div class="new-teg" id="add-teg">
          <form>
            <input class="form-control new-teg-text" type="text"  placeholder="Новый тэг"> 
            <div class="btn btn-primary btn-sm add center" onclick="save_teg()">
              ✓
            </div>
            <div class="btn btn-danger btn-sm cancel center" onclick="cancel_teg()">
              ✗
            </div>
          </form> 
        </div>
      </div>
      <div class="col-1 col-sm-4"></div>
    </div>
    <div class="row">
      <div class="col-1 col-sm-2"></div>
      <div class="col-10">
        <div id="reminders" class="row"></div>
      </div>
    </div>
  </div>
  
  <script src="../js/lib/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="../js/components/navbar.js"></script>
  <script>
      const addTegDiv = document.getElementById('add-teg');
      const addBtnDiv = document.getElementById('btn-add');
      const inputTeg = addTegDiv.querySelector('input.new-teg-text');
      
      function add_teg() {
        addTegDiv.style.display = 'block';
        addBtnDiv.style.display = 'none';
        inputTeg.focus();
      }
      
      function cancel_teg() {
        inputTeg.value = '';
        addTegDiv.style.display = 'none';
        addBtnDiv.style.display = 'block';
      }
      
      async function save_teg() {
        const newTagName = inputTeg.value.trim();
      
        if (newTagName === "") {
          alert("Пожалуйста, введите название тэга");
          return;
        }
              fetch('/api/tags',{
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json' 
                },
                body: JSON.stringify({ name: newTagName })  
              })
          

          .then(data => {
            renderTags(data);
          })
          .catch(error => {
            console.error('Ошибка сети:', error);
          });

          function renderTags(data) {
            
        if (data.ok) {
          alert('Тэг успешно добавлен');
          inputTeg.value = '';
          addTegDiv.style.display = 'none';
          addBtnDiv.style.display = 'block';
          location.reload();
        }else {
          alert('Ошибка при сохранении тэга: ' + data.statusText);
        }

          }
      }

  window.onload = () => {
  addTegDiv.style.display = 'none';
};
  </script>
  <script>
    
  
    
    
    async function updateReminderStatus(reminderId) {
      try {
        const response = await fetch(`/api/reminders/${reminderId}/complete`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json' 
          },
          body: JSON.stringify({ status: 'completed' })  
        });
        if (!response.ok) {
          throw new Error('Ошибка обновления статуса');
        }
        location.reload();
      } catch (error) {
        console.error('Ошибка:', error);
      }
    }
  function fetchReminders() {
    fetch('/api/reminders')
      .then(response => {
      if (!response.ok) {
        throw new Error('Сетевой ответ не в порядке');
      }
      return response.json();
      })
      .then(data => {
        renderReminders(data); 
      })
      .catch(error => {
        console.error('Ошибка получения данных:', error);
      });
    }
   
  </script>
  <script>
    document.getElementById('saveButton').addEventListener('click', async function(event) {
    
      var input = document.getElementById('reminderInput');
      var timeInput = document.getElementById('timeInput');
      var reminderText = input.value.trim();
      var timeText = timeInput.value;
      var selectedTag = Array.from(document.querySelectorAll('input[name="tag"]:checked')).map(tag => tag.value);
    
      if (reminderText && timeText) {
        try {
          const response = await fetch('/api/reminders', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ 
              text: reminderText,
              tags: selectedTag,  
              time: timeText,
              status: "active"
            })
          });
          
          if (response.ok) {
            input.value = '';
            timeInput.value = '';
            location.reload();
          } else {
            alert('Ошибка при сохранении напоминания: ' + response.statusText);
          }
        } catch (error) {
          alert('Ошибка сети: ' + error.message);
        }
      } else {
        alert('Пожалуйста, введите текст напоминания и время.');
      }
    });
  </script>
  <script>
    async function updateProgressBar() {
      try {
        const response = await fetch(`/api/reminders`);
        const reminders = await response.json(); 
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        const todayStr = `${yyyy}-${mm}-${dd}`;  
        const todaysReminders = reminders.filter(reminder => {
          if (!reminder.time) return false;
          return reminder.time.substring(0, 10) === todayStr;
        });
  
        const totalReminders = todaysReminders.length;
        const completedCount = todaysReminders.filter(r => r.status === 'completed').length;
        let progress = 0;
        if (completedCount != totalReminders) {
          progress = (completedCount / totalReminders) * 100;
        } else if (totalReminders!=0){
          progress = 100;
        }

        progress = Math.min(progress, 100);
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
          progressBar.style.width = `${progress}%`; 
          progressBar.setAttribute('aria-valuenow', progress);
          progressBar.textContent = `${Math.round(progress)}%`; 
        }
  
      } catch (error) {
        console.error('Error fetching reminders:', error);
      }
    }
  
    document.addEventListener('DOMContentLoaded', updateProgressBar);
  </script>
  <script>
    async function loadTags() {
      try {
        const response = await fetch('api/tags');
        const tags = await response.json();
  
        const tagsList = document.getElementById('tagsList');
        tagsList.innerHTML = ''; 
  
        tags.forEach((tag, index) => {
          const div = document.createElement('div');
          div.classList.add('form-check');
          const input = document.createElement('input');
          input.classList.add('form-check-input', 'm-1');
          input.type = 'radio';
          input.name = 'tag';
          input.id = `tag${index}`;
          input.value = tag.name.replace(/&#\d+;/g, '');  
          if (index === 0) input.checked = true;
          const label = document.createElement('label');
          label.classList.add('form-check-label');
          label.setAttribute('for', input.id);
          label.innerHTML = tag.name; 
          div.appendChild(input);
          div.appendChild(label);
          tagsList.appendChild(div);
        });
      } catch (error) {
        console.error('Ошибка загрузки тегов:', error);
      }
    }
    window.addEventListener('DOMContentLoaded', loadTags);
  </script>
  <script>
   
      let allReminders = []; // сюда загрузим все напоминания после запроса
    
      // Функция загрузки тегов
      async function loadTagsList() {
        try {
          const response = await fetch('/api/tags');
          if (!response.ok) throw new Error('Ошибка сети при загрузке тегов');
          const tags = await response.json();
      
          const tagsList = document.getElementById('tags');
      
          // Очищаем список, оставляем "Все"
          while (tagsList.children.length > 1) {
            tagsList.removeChild(tagsList.lastChild);
          }
      
          tags.forEach((tag, index) => {
            const li = document.createElement('li');
            li.classList.add('form-check' , 'm-1');
      
            const input = document.createElement('input');
            input.type = 'radio';
            input.name = 'flexRadioDefault';
            input.id = `tag${index}`;
            input.classList.add('form-check-input');
            input.value = tag.name;
      
            const label = document.createElement('label');
            label.classList.add('form-check-label');
            label.setAttribute('for', input.id);
            label.textContent = tag.name;
      
            li.appendChild(input);
            li.appendChild(label);
            tagsList.appendChild(li);
          });
      
          // Навешиваем обработчик **один раз** после создания всех радио
          const radios = document.querySelectorAll('input[name="flexRadioDefault"]');
          radios.forEach(input => {
            input.addEventListener('change', () => {
              if (input.value === 'Все') {
                renderAllReminders();
              } else {
                filterAndRenderReminders(input.value);
              }
            });
          });
      
        } catch (error) {
          console.error('Ошибка загрузки тегов:', error);
        }
      }
    
      // Функция загрузки напоминаний
      async function loadReminders() {
        try {
          const response = await fetch('/api/reminders');
          if (!response.ok) throw new Error('Сетевой ответ не в порядке');
          allReminders = await response.json();
    
          // По умолчанию отображаем все
          filterAndRenderReminders('Все');
        } catch (error) {
          console.error('Ошибка получения данных:', error);
        }
      }
    
      // Функция фильтрации и отображения
      function filterAndRenderReminders(tag) {
        if (tag === 'Все') {
          // показать все без фильтрации
          renderAllReminders();
          return;
        }
      
        // иначе фильтрация по тегу
        const filteredReminders = allReminders.filter(r => r.tags.includes(tag));
        renderReminders(filteredReminders);
      }
      function renderAllReminders() {
        renderReminders(allReminders);
      }
    
      function renderReminders(data) {
        const remindersContainer = document.getElementById('reminders');
        remindersContainer.innerHTML = '';
        data.forEach(reminder => {
          const div = document.createElement('div');
          div.className = 'alert alert-white my-alert m-3';
          div.role = "alert";
          div.addEventListener('click', () => {
            location.href = '/edit?id=' + reminder.id;
          });
          const buttonClass = getButtonClass(reminder.status);
          const buttonText = getButtonText(reminder.status);
          const button = document.createElement('button');
          button.type = "button";
          button.className = `btn ${buttonClass} btn-sm`;
          button.innerText = buttonText;
          button.onclick = (event) => {
            event.stopPropagation();
            updateReminderStatus(reminder.id);
          };
          div.innerHTML = `
          <p>${reminder.text}</p>
          <hr>
          <div class="row">
            <div class="col-6">
              ${new Date(reminder.time).toLocaleString()} 
            </div> 
            <div class="col-6">
              <p>#${reminder.tags.join(', ')}</p>
            </div> 
          </div>
        `;
        div.querySelector('.col-6:nth-child(2)').appendChild(button); 
        remindersContainer.appendChild(div);
      });
      }

  function getButtonClass(status) {
    switch (status) {
      case 'active':
        return 'btn-warning';
      case 'forgotten':
        return 'btn-secondary';
      case 'completed':
        return 'btn-outline-warning';
      default:
        return 'btn-default';
    }
  }

  function getButtonText(status) {
    switch (status) {
      case 'active':
        return 'Выполнить';
      case 'forgotten':
        return 'Просрочено';
      case 'completed':
        return 'Выполнено';
      default:
        return 'Ошибка';
    }
  }

  // Загрузка данных после загрузки DOM
  window.addEventListener('DOMContentLoaded', () => {
    loadTagsList();
    loadReminders();
  });
</script>
</body>  
</html>
