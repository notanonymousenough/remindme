<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
 
  <link rel="stylesheet" href="../css/bootstrap.min.css">
  <link rel="stylesheet" href="../css/styles.css">
  <link rel="icon" href="../assets/icons/icon.png" type="image/x-icon">

  <title>RemindMe</title>
</head> 
<body>

  <nav class="mnb navbar navbar-default navbar-fixed-top btn-menu " >
    <div class="container-fluid">
      <div class="navbar-header ">
        <button type="button" id="msbo"   class="navbar-toggler collapsed btn-box"  data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" >
          <span class="navbar-toggler-icon "></span>
        </button> 
      </div>
    </div>
  </nav>
 
  <div class="msb   " id="msb" >
    <nav class="navbar navbar-default  " role="navigation">
      <div class="brand-name-wrapper">
        <div class="avatar">
          <img  src="../assets/icons/avatar.jpg" alt="" class="round" width="40" height="40">
          <a class="navbar-brand" href="/user" >
            <b> Профиль</b>
          </a>
        </div>
      </div>
      <div class="side-menu-container  ">
        <ul class="nav navbar-nav ">
          <li>
            <a class="nav-link text-dark item" href="/reminders">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25"  fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16"><path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/></svg>
              Напоминания
            </a>
          </li>
          <li>
            <a class="nav-link text-dark item" href="/habits">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-bell" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z"/></svg> 
              Привычки
            </a>
          </li>
          <li>
            <a class="nav-link text-dark item" href="/telegram">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-telegram" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8.287 5.906c-.778.324-2.334.994-4.666 2.01-.378.15-.577.298-.595.442-.03.243.275.339.69.47l.175.055c.408.133.958.288 1.243.294.26.006.549-.1.868-.32 2.179-1.471 3.304-2.214 3.374-2.23.05-.012.12-.026.166.016.047.041.042.12.037.141-.03.129-1.227 1.241-1.846 1.817-.193.18-.33.307-.358.336a8.154 8.154 0 0 1-.188.186c-.38.366-.664.64.015 1.088.327.216.589.393.85.571.284.194.568.387.936.629.093.06.183.125.27.187.331.236.63.448.997.414.214-.02.435-.22.547-.82.265-1.417.786-4.486.906-5.751a1.426 1.426 0 0 0-.013-.315.337.337 0 0 0-.114-.217.526.526 0 0 0-.31-.093c-.3.005-.763.166-2.984 1.09z"/></svg>
              Телеграм-бот
            </a>
          </li>
          <li>
            <a class="nav-link text-dark item" href="#item-4">
              <svg xmlns="http://www.w3.org/2000/svg" width="25" height="25" fill="currentColor" class="bi bi-question-lg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M4.475 5.458c-.284 0-.514-.237-.47-.517C4.28 3.24 5.576 2 7.825 2c2.25 0 3.767 1.36 3.767 3.215 0 1.344-.665 2.288-1.79 2.973-1.1.659-1.414 1.118-1.414 2.01v.03a.5.5 0 0 1-.5.5h-.77a.5.5 0 0 1-.5-.495l-.003-.2c-.043-1.221.477-2.001 1.645-2.712 1.03-.632 1.397-1.135 1.397-2.028 0-.979-.758-1.698-1.926-1.698-1.009 0-1.71.529-1.938 1.402-.066.254-.278.461-.54.461h-.777ZM7.496 14c.622 0 1.095-.474 1.095-1.09 0-.618-.473-1.092-1.095-1.092-.606 0-1.087.474-1.087 1.091S6.89 14 7.496 14Z"/></svg>
              Помощь
            </a>
          </li>	
        </ul>
      </div>
    </nav>  
  </div>

  <div class="mcw">
    <div class="row">
      <div class="col-2 col-sm-3"></div>
      <div class="dropdown col-7 col-sm-7 m-4">
        <select id="dropdownHabits" class="form-select bord-1" onchange="fetchAndDisplayHabit()">
          <option value="">Выберите привычку</option>
        </select> 
      </div>
    </div>
    <div class="habit-rows" id="habitRows">
    </div>
   
      <div class="row">
          <div class="col-2 col-sm-3"></div>
          <div class="col-8">
              <table class="table table-bordered table-priv" id="habitsTable">
                  <thead>
                      <tr>
                        <th colspan="7" id="monthHeader"></th>
                      </tr>
                  </thead>
                  <tbody id="tableBody"></tbody>
              </table>
          </div>
          <div class="col-1"></div>
      </div>
  
      <div class="row">
          <div class="col-2 col-sm-3"></div>
          <div class="col-5">
              <div id="streakDiv"></div>
          </div>
      </div>
  
  </div>   

  <script src="../js/lib/bootstrap.bundle.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="../js/components/navbar.js"></script>
  
<script>
  document.addEventListener("DOMContentLoaded", function() {
    fetchHabits(); 
    
});

async function fetchHabits() {
    try {
        const response = await fetch('/api/habits');
              if (!response.ok) {
                  throw new Error('Ошибка сети');
              }
              const habits = await response.json();
              populateDropdown(habits);
          } catch (error) {
              console.error('Ошибка:', error);
          }
      }

      function populateDropdown(habits) {
          const dropdownHabits = document.getElementById('dropdownHabits');
          habits.forEach(habit => {
              const option = document.createElement('option');
              option.value = habit.id; // Убедитесь, что habit.id существует
              option.textContent = habit.text; // Убедитесь, что habit.name существует
              dropdownHabits.appendChild(option);
          });
      }

      async function fetchAndDisplayHabit() {
          const habitId = document.getElementById('dropdownHabits').value;
          if (!habitId) return; 

          try {
              const response = await fetch(`/api/habits/${habitId}`);
              if (!response.ok) {
                  throw new Error('Ошибка сети при получении привычки');
              }
              const habit = await response.json();
              displayHabit(habit);
          } catch (error) {
              console.error('Ошибка:', error);
          }
      }

      function displayHabit(habit) {
        const endDate = new Date(habit.endDate);
        const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];
        const month = monthNames[endDate.getMonth()];
        document.getElementById('monthHeader').innerText = month;
    
        const customPeriod = habit.customPeriod.map(date => new Date(date).getDate());
        const startDate = new Date(habit.startDate).getDate();
        const lastDate = endDate.getDate();
    
        let tableBodyHtml = '<tr>';
        for (let day = 1; day <= lastDate; day++) {
            let className = '';
            if (day >= startDate && customPeriod.includes(day)) {
                className = 'bg-success';
            } else if (day >= startDate && day < lastDate) {
                className = 'bg-danger';
            }
            tableBodyHtml += `<td class="${className}" scope="col">${day}</td>`;
            if (day % 7 === 0) {
                tableBodyHtml += '</tr><tr>';
            }
        }
        tableBodyHtml += '</tr>';
        document.getElementById('tableBody').innerHTML = tableBodyHtml;
    
        const currentStreak = habit.currentStreak;
        document.getElementById('streakDiv').innerHTML = `${currentStreak} дня подряд <p>Молодец!!! &#128077</p>`;
        const buttonClass = getButtonClass(habit.status);
        const buttonText = getButtonText(habit.status);

        const habitDetailsHtml = `
        <div class="row">
            <div class="col-2 col-sm-3"></div>
            <div class="col-5 col-sm-3 col-lg-2">
                <h7>${habit.text}</h7>
            </div>
            <div class="col-3 col-sm-3 col-md-2 col-lg-2 btn-delete-h">
                <button type="button" class="btn ${buttonClass} btn-sm" id="performHabit-${habit.id}">${buttonText}</button>
            </div>
            <div class="col-6 col-sm-1 col-md-2 col-lg-1 btn-delete-h">
                <button type="button" class="btn btn-sm btn-danger" id="deleteHabit-${habit.id}">Удалить</button>
            </div>
        </div>
        <p></p>`;

    const habitRows = document.getElementById('habitRows');
    habitRows.innerHTML = habitDetailsHtml;

    // Изменено на уникальный ID кнопки "Удалить"
    const deleteButton = document.getElementById(`deleteHabit-${habit.id}`);
deleteButton.addEventListener('click', async function() {
    if (confirm('Вы уверены, что хотите удалить эту привычку?')) { 
        try {
            const response = await fetch(`/api/habits/${habit.id}`, { // Исправлено на обратные кавычки
                method: 'DELETE',
            });

            if (!response.ok) {
                throw new Error('Ошибка сети при удалении привычки');
            }

            alert('Привычка успешно удалена!');
            location.reload(); // Обновите список привычек


            document.getElementById('habitRows').innerHTML = ''; // Очистите детали привычки
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }
});

// Выполнение привычки
const performHabit = document.getElementById(`performHabit-${habit.id}`);
performHabit.addEventListener('click', async function() {
    if (!habit.id) return; // Используйте habit.id вместо habitId

    try {
        const response = await fetch(`/api/habits/${habit.id}/complete`, { // Исправлено на обратные кавычки
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json' // Указываем, что контент отправляется в формате JSON
            },
            body: JSON.stringify({ status: 'completed' }) // Отправляем JSON-объект с новым статусом
        });

        if (!response.ok) {
            throw new Error('Ошибка обновления статуса');
        }

        fetchHabits(); // Обновляем список привычек
    } catch (error) {
        console.error('Ошибка:', error);
    }
});

// Получение класса для кнопки в зависимости от статуса
function getButtonClass(status) {
    switch (status) {
        case 'active':
            return 'btn-warning';
        case 'completed':
            return 'btn-outline-warning';
        default:
            return 'btn-default';
    }
}
function getButtonText(status) {
  switch (status) {
      case 'active':
        return 'Выполнить';
      case 'completed':
        return 'Выполнено';
      default:
        return 'Ошибка';
  }
} function fetchHabits2() {
      fetch('/api/habits')
          .then(response => {
              if (!response.ok) {
                  throw new Error('Сетевой ответ не в порядке');
              }
              return response.json();
          })
          .then(data => {
            displayHabit(data); // Переносим функцию рендеринга
          })
          .catch(error => {
              console.error('Ошибка получения данных:', error);
          });
    }
   
  }

    
</script>
</body>  
</html>
